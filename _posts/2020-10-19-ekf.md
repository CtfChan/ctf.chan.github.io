---
title: "Robotics Blog: Extended Kalman Filter"
tags: [robotics]
style: fill
color: dark
description:
---
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>

This posts outlines an example of localization using an EKF filter.



State
$$
X_t =
\begin{bmatrix}
x_t \\
y_t \\
\phi_t \\
v_t \\
\end{bmatrix}
$$

Control
$$
u_t =
\begin{bmatrix}
v_t \\
\omega_t \\
\end{bmatrix}
$$

Observations
$$
z_t =
\begin{bmatrix}
x_t \\
y_t \\
\end{bmatrix}
$$

## Motion Model
Differential Drive Robot
$$
\dot{x} = v cos(\phi)
$$

$$
\dot{y} = v sin(\phi)
$$

$$
\dot{\phi} = \omega
$$


For small time step

$$
X_{t+1} =
\begin{bmatrix}
x_t + v cos \phi_t \Delta_t \\
y_t + v sin \phi_t \Delta_t \\
\phi_t + \omega_t \Delta_t \\
v_t
\end{bmatrix}
$$

We can express this in matrix form


$$
X_{t+1} =
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 \\
\end{bmatrix}
\begin{bmatrix}
x_t  \\
y_t  \\
\phi_t  \\
v_t  \\
\end{bmatrix} +
\begin{bmatrix}
cos \phi_t \Delta_t  & 0 \\
sin \phi_t \Delta_t & 0   \\
0 & \Delta_t \\
1 & 0 \\
\end{bmatrix}
\begin{bmatrix}
v_t \\
\omega_t \\
\end{bmatrix}
$$

$$
X_{t+1} =  F X_{t} + B u_t
$$

Jacobian of F
$$
J_F =
\begin{bmatrix}
\frac{\partial x}{\partial x} & \frac{\partial x}{\partial y} & \frac{\partial x}{\partial \phi} & \frac{\partial x}{\partial v} \\
\frac{\partial y}{\partial x} & \frac{\partial y}{\partial y} & \frac{\partial y}{\partial \phi} & \frac{\partial y}{\partial v} \\
\frac{\partial \phi}{\partial x} & \frac{\partial \phi}{\partial y} & \frac{\partial \phi}{\partial \phi} & \frac{\partial \phi}{\partial v} \\
\frac{\partial v}{\partial x} & \frac{\partial v}{\partial y} & \frac{\partial v}{\partial \phi} & \frac{\partial v}{\partial v} \\
\end{bmatrix} =
\begin{bmatrix}
1 & 0 & -v sin \phi \Delta_t & cos \phi \Delta_t \\
0 & 1 & v cos \phi \Delta_t & sin \phi \Delta_t \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1 \\
\end{bmatrix}
$$

## Observation Model
$$
z_t = H x_t
$$

$$
z_t =
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
\end{bmatrix}
\begin{bmatrix}
x_t \\
y_t \\
\phi_t \\
v_t
\end{bmatrix} =
\begin{bmatrix}
x_t \\
y_t
\end{bmatrix}
$$

$$
J_H =
\begin{bmatrix}
\frac{\partial x}{\partial x} & \frac{\partial x}{\partial y} & \frac{\partial x}{\partial \phi} & \frac{\partial x}{\partial v} \\
\frac{\partial y}{\partial x} & \frac{\partial y}{\partial y} & \frac{\partial y}{\partial \phi} & \frac{\partial y}{\partial v} \\
\end{bmatrix} =
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0
\end{bmatrix}
$$


State Predict:
$$
X_{Pred} = F X_t + B u_t
$$

$$
P_{Pred} = J_F P_t J_F^T + Q
$$

Update:

$$
z_{Pred} = H X_{Pred}
$$

$$
Y = z - z_{Pred}
$$

$$
S = J_H P_{Pred} J_H^T + R
$$

$$
K = P_{Pred} J_H^T S^{-1}
$$

$$
X_{t+1} = X_{Pred} + KY
$$

$$
P_{t+1} = (I - K J_H) P_{Pred}
$$

